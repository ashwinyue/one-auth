# æ•°æ®æƒé™è®¾è®¡ä¸å®ç°æ–¹æ¡ˆ

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæƒé™æ¶æ„æ¦‚è§ˆ](#ç³»ç»Ÿæƒé™æ¶æ„æ¦‚è§ˆ)
2. [èœå•æƒé™å®ç°æ–¹æ¡ˆ](#èœå•æƒé™å®ç°æ–¹æ¡ˆ)
3. [APIæƒé™å®ç°æ–¹æ¡ˆ](#apiæƒé™å®ç°æ–¹æ¡ˆ)
4. [æŒ‰é’®æƒé™å®ç°æ–¹æ¡ˆ](#æŒ‰é’®æƒé™å®ç°æ–¹æ¡ˆ)
5. [æ•°æ®æƒé™TODOæ–¹æ¡ˆ](#æ•°æ®æƒé™todoæ–¹æ¡ˆ)
6. [æƒé™è¡¨è®¾è®¡å¯¹æ¯”](#æƒé™è¡¨è®¾è®¡å¯¹æ¯”)
7. [å®æ–½å»ºè®®](#å®æ–½å»ºè®®)

---

## ğŸ—ï¸ ç³»ç»Ÿæƒé™æ¶æ„æ¦‚è§ˆ

### æƒé™ç±»å‹åˆ†ç±»

```go
type ResourceType string

const (
    ResourceTypeAPI     ResourceType = "api"     // APIæ¥å£æƒé™
    ResourceTypeMenu    ResourceType = "menu"    // èœå•æƒé™
    ResourceTypeData    ResourceType = "data"    // æ•°æ®æƒé™
    ResourceTypeFeature ResourceType = "feature" // åŠŸèƒ½æƒé™
)
```

### æ ¸å¿ƒæƒé™è¡¨ç»“æ„

```sql
CREATE TABLE `permissions` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'æƒé™ä¸»é”®ID',
  `tenant_id` bigint NOT NULL COMMENT 'ç§Ÿæˆ·ID',
  `permission_code` varchar(100) NOT NULL COMMENT 'æƒé™ç¼–ç ï¼ˆæ ¼å¼ï¼šmodule:actionï¼‰',
  `name` varchar(100) NOT NULL COMMENT 'æƒé™åç§°',
  `description` varchar(500) DEFAULT NULL COMMENT 'æƒé™æè¿°',
  `resource_type` enum('api','menu','data','feature') NOT NULL DEFAULT 'menu' COMMENT 'èµ„æºç±»å‹',
  `resource_path` varchar(255) DEFAULT NULL COMMENT 'APIè·¯å¾„æˆ–èµ„æºæ ‡è¯†',
  `http_method` varchar(20) DEFAULT NULL COMMENT 'HTTPæ–¹æ³•ï¼šGET,POST,PUT,DELETEç­‰',
  `action` varchar(50) DEFAULT NULL COMMENT 'æ“ä½œç±»å‹ï¼šview,create,update,delete,exportç­‰',
  `status` tinyint(1) NOT NULL DEFAULT '1' COMMENT 'çŠ¶æ€ï¼š1-å¯ç”¨ï¼Œ0-ç¦ç”¨',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  `deleted_at` datetime DEFAULT NULL COMMENT 'åˆ é™¤æ—¶é—´ï¼ˆè½¯åˆ é™¤ï¼‰',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_permission_code_tenant` (`permission_code`, `tenant_id`),
  KEY `idx_tenant_id` (`tenant_id`),
  KEY `idx_resource_type` (`resource_type`),
  KEY `idx_action` (`action`),
  KEY `idx_status` (`status`),
  KEY `idx_deleted_at` (`deleted_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='æƒé™è¡¨ï¼ˆé‡æ„ç‰ˆ-ç‹¬ç«‹æƒé™ç®¡ç†ï¼‰';
```

---

## ğŸ¨ èœå•æƒé™å®ç°æ–¹æ¡ˆ

### è®¾è®¡ç‰¹ç‚¹

- âœ… **éœ€è¦å…³è”è¡¨**ï¼š`menu_permissions`
- âœ… **å¤šå¯¹å¤šå…³ç³»**ï¼šä¸€ä¸ªèœå•å¤šä¸ªæƒé™ï¼Œä¸€ä¸ªæƒé™å¤šä¸ªèœå•
- âœ… **æƒé™åˆ†çº§**ï¼šå¿…éœ€æƒé™ vs å¯é€‰æƒé™
- âœ… **åŠ¨æ€UIæ§åˆ¶**ï¼šæ ¹æ®æƒé™æ˜¾ç¤º/éšè—åŠŸèƒ½

### èœå•æƒé™å…³è”è¡¨

```sql
CREATE TABLE `menu_permissions` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `tenant_id` bigint NOT NULL COMMENT 'ç§Ÿæˆ·ID',
  `menu_id` bigint NOT NULL COMMENT 'èœå•ID',
  `permission_id` bigint NOT NULL COMMENT 'æƒé™ID',
  `is_required` tinyint(1) NOT NULL DEFAULT '0' COMMENT 'æ˜¯å¦ä¸ºè®¿é—®èœå•çš„å¿…éœ€æƒé™',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_menu_permission` (`menu_id`, `permission_id`),
  KEY `idx_tenant_id` (`tenant_id`),
  KEY `idx_menu_id` (`menu_id`),
  KEY `idx_permission_id` (`permission_id`),
  KEY `idx_required` (`is_required`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='èœå•æƒé™å…³è”è¡¨';
```

### èœå•ç±»å‹å®šä¹‰

```sql
-- èœå•è¡¨ä¸­çš„èœå•ç±»å‹
`menu_type` tinyint NOT NULL DEFAULT '1' COMMENT 'èœå•ç±»å‹ï¼š1-ç›®å½•ï¼Œ2-èœå•ï¼Œ3-æŒ‰é’®ï¼Œ4-æ¥å£'
```

```go
// èœå•ç±»å‹æšä¸¾
type MenuType int8

const (
    MenuTypeDirectory MenuType = 1 // ç›®å½•
    MenuTypeMenu      MenuType = 2 // èœå•
    MenuTypeButton    MenuType = 3 // æŒ‰é’®
    MenuTypeAPI       MenuType = 4 // æ¥å£
)
```

### èœå•æƒé™é…ç½®ç¤ºä¾‹

```go
// ç”¨æˆ·ç®¡ç†èœå•æƒé™é…ç½®
var userMenuPermissions = []MenuPermissionConfig{
    {
        PermissionCode: "user:view",
        IsRequired:     true,  // å¿…éœ€æƒé™ï¼šè®¿é—®èœå•å¿…é¡»æœ‰
    },
    {
        PermissionCode: "user:create", 
        IsRequired:     false, // å¯é€‰æƒé™ï¼šæœ‰æƒé™æ˜¾ç¤º"æ–°å¢"æŒ‰é’®
    },
    {
        PermissionCode: "user:update",
        IsRequired:     false, // å¯é€‰æƒé™ï¼šæœ‰æƒé™æ˜¾ç¤º"ç¼–è¾‘"æŒ‰é’®
    },
    {
        PermissionCode: "user:delete",
        IsRequired:     false, // å¯é€‰æƒé™ï¼šæœ‰æƒé™æ˜¾ç¤º"åˆ é™¤"æŒ‰é’®
    },
}
```

### èœå•æƒé™æ£€æŸ¥é€»è¾‘

```go
// èœå•æƒé™çŸ©é˜µ
type MenuPermissionMatrix struct {
    Menu                *MenuM            `json:"menu"`
    RequiredPermissions []*PermissionNewM `json:"required_permissions"`
    OptionalPermissions []*PermissionNewM `json:"optional_permissions"`
    AllPermissions      []*PermissionNewM `json:"all_permissions"`
}

// æ£€æŸ¥æ˜¯å¦å…·æœ‰å¿…éœ€æƒé™
func (matrix *MenuPermissionMatrix) HasRequiredPermissions(userPermissions []string) bool {
    if len(matrix.RequiredPermissions) == 0 {
        return true // æ²¡æœ‰å¿…éœ€æƒé™ï¼Œå…è®¸è®¿é—®
    }

    permissionMap := make(map[string]bool)
    for _, perm := range userPermissions {
        permissionMap[perm] = true
    }

    for _, reqPerm := range matrix.RequiredPermissions {
        if !permissionMap[reqPerm.PermissionCode] {
            return false // ç¼ºå°‘å¿…éœ€æƒé™ï¼Œæ‹’ç»è®¿é—®
        }
    }
    return true
}

// è·å–ç”¨æˆ·åœ¨æ­¤èœå•å¯æ‰§è¡Œçš„æ“ä½œ
func (matrix *MenuPermissionMatrix) GetAvailableActions(userPermissions []string) []string {
    permissionMap := make(map[string]bool)
    for _, perm := range userPermissions {
        permissionMap[perm] = true
    }

    var actions []string
    for _, perm := range matrix.AllPermissions {
        if permissionMap[perm.PermissionCode] && perm.Action != nil {
            actions = append(actions, *perm.Action)
        }
    }
    return actions
}
```

### å‰ç«¯åº”ç”¨ç¤ºä¾‹

```javascript
// æ ¹æ®ç”¨æˆ·æƒé™åŠ¨æ€æ¸²æŸ“èœå•å’ŒæŒ‰é’®
const userMenuActions = getUserMenuActions(menuId);

// èœå•è®¿é—®æ§åˆ¶
if (hasRequiredPermissions(menuId)) {
    renderMenu(menuId);
}

// æŒ‰é’®æ˜¾ç¤ºæ§åˆ¶
{userMenuActions.includes('create') && <Button>æ–°å¢ç”¨æˆ·</Button>}
{userMenuActions.includes('update') && <Button>ç¼–è¾‘ç”¨æˆ·</Button>}
{userMenuActions.includes('delete') && <Button>åˆ é™¤ç”¨æˆ·</Button>}
{userMenuActions.includes('export') && <Button>å¯¼å‡ºæ•°æ®</Button>}
```

---

## ğŸ”Œ APIæƒé™å®ç°æ–¹æ¡ˆ

### è®¾è®¡ç‰¹ç‚¹

- âŒ **ä¸éœ€è¦å…³è”è¡¨**ï¼šç›´æ¥é€šè¿‡æƒé™è¡¨å­—æ®µå­˜å‚¨
- âœ… **ä¸€å¯¹ä¸€æ˜ å°„**ï¼šAPIè·¯å¾„ + HTTPæ–¹æ³• â†’ æƒé™
- âœ… **ç®€å•é«˜æ•ˆ**ï¼šç›´æ¥æŸ¥è¯¢åŒ¹é…

### APIæƒé™å­˜å‚¨æ–¹å¼

```go
// APIæƒé™ç›´æ¥å­˜å‚¨åœ¨æƒé™è¡¨ä¸­
type APIPermission struct {
    PermissionCode string       `json:"permission_code"` // "user:api:list"
    Name          string        `json:"name"`            // "ç”¨æˆ·åˆ—è¡¨API"
    ResourceType  ResourceType  `json:"resource_type"`   // "api"
    ResourcePath  string        `json:"resource_path"`   // "/v1/users"
    HTTPMethod    string        `json:"http_method"`     // "GET"
    Action        string        `json:"action"`          // "view"
}
```

### APIæƒé™é…ç½®ç¤ºä¾‹

```go
// APIæƒé™é…ç½®
var apiPermissions = []PermissionNewM{
    {
        PermissionCode: "user:api:list",
        Name:          "ç”¨æˆ·åˆ—è¡¨API",
        ResourceType:  ResourceTypeAPI,
        ResourcePath:  "/v1/users",
        HTTPMethod:    "GET",
        Action:        "view",
    },
    {
        PermissionCode: "user:api:create",
        Name:          "åˆ›å»ºç”¨æˆ·API", 
        ResourceType:  ResourceTypeAPI,
        ResourcePath:  "/v1/users",
        HTTPMethod:    "POST",
        Action:        "create",
    },
    {
        PermissionCode: "user:api:update",
        Name:          "æ›´æ–°ç”¨æˆ·API",
        ResourceType:  ResourceTypeAPI,
        ResourcePath:  "/v1/users/:id",
        HTTPMethod:    "PUT", 
        Action:        "update",
    },
    {
        PermissionCode: "user:api:delete",
        Name:          "åˆ é™¤ç”¨æˆ·API",
        ResourceType:  ResourceTypeAPI,
        ResourcePath:  "/v1/users/:id",
        HTTPMethod:    "DELETE",
        Action:        "delete",
    },
}
```

### APIæƒé™æ£€æŸ¥é€»è¾‘

```go
// APIæƒé™æ£€æŸ¥ï¼ˆå·²å®ç°ï¼‰
func (a *Authz) checkAPIAccessForRegularUser(userID, tenantIdentifier, accessPath, httpMethod string) (bool, error) {
    // æŸ¥è¯¢APIå¯¹åº”çš„æƒé™
    var permissions []struct {
        PermissionCode string `gorm:"column:permission_code"`
    }

    err := a.tenantResolver.(*DefaultTenantResolver).db.Table("permissions").
        Select("permission_code").
        Where("resource_type = 'api' AND resource_path = ? AND http_method = ? AND deleted_at IS NULL",
            accessPath, httpMethod).
        Find(&permissions).Error

    if err != nil {
        return false, err
    }

    // å¦‚æœAPIæ²¡æœ‰é…ç½®æƒé™ï¼Œæ ¹æ®é»˜è®¤ç­–ç•¥å†³å®š
    if len(permissions) == 0 {
        return false, nil // é»˜è®¤æ‹’ç»æœªé…ç½®æƒé™çš„API
    }

    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰å…¶ä¸­ä»»ä¸€æƒé™
    for _, perm := range permissions {
        hasPermission, err := a.CheckPermission(userID, tenantIdentifier, perm.PermissionCode)
        if err != nil {
            continue
        }
        if hasPermission {
            return true, nil
        }
    }

    return false, nil
}
```

### APIæƒé™ä¸­é—´ä»¶

```go
// APIæƒé™æ£€æŸ¥ä¸­é—´ä»¶
func APIPermissionMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        userID := getUserID(c)
        tenantID := getTenantID(c)
        apiPath := c.Request.URL.Path
        httpMethod := c.Request.Method

        hasAccess, err := authz.CheckAPIAccess(userID, tenantID, apiPath, httpMethod)
        if err != nil || !hasAccess {
            c.JSON(403, gin.H{"error": "API access denied"})
            c.Abort()
            return
        }

        c.Next()
    }
}
```

---

## ğŸ”˜ æŒ‰é’®æƒé™å®ç°æ–¹æ¡ˆ

### è®¾è®¡ç‰¹ç‚¹

- âœ… **ç»Ÿä¸€å­˜å‚¨**ï¼šæŒ‰é’®ä½œä¸ºèœå•ç±»å‹å­˜å‚¨åœ¨èœå•è¡¨ä¸­
- âœ… **å±‚çº§å…³ç³»**ï¼šé€šè¿‡ `parent_id` å»ºç«‹ä¸çˆ¶èœå•çš„å…³ç³»
- âœ… **æƒé™å…³è”**ï¼šé€šè¿‡ `menu_permissions` è¡¨å…³è”æƒé™

### æŒ‰é’®èœå•ç»“æ„

```sql
-- æŒ‰é’®åœ¨èœå•è¡¨ä¸­çš„å­˜å‚¨
INSERT INTO menus VALUES 
-- çˆ¶èœå•ï¼šç”¨æˆ·ç®¡ç†
(1, 1, NULL, 'user_management', 'ç”¨æˆ·ç®¡ç†', 2, '/user', 'UserManagement', 'user', 1, 1, 1, NULL),
-- å­æŒ‰é’®
(2, 1, 1, 'user_create_btn', 'æ–°å¢ç”¨æˆ·', 3, NULL, NULL, 'plus', 2, 1, 1, NULL),
(3, 1, 1, 'user_edit_btn', 'ç¼–è¾‘ç”¨æˆ·', 3, NULL, NULL, 'edit', 3, 1, 1, NULL),
(4, 1, 1, 'user_delete_btn', 'åˆ é™¤ç”¨æˆ·', 3, NULL, NULL, 'delete', 4, 1, 1, NULL);
```

### æŒ‰é’®æƒé™é…ç½®

```go
// æŒ‰é’®æƒé™é…ç½®ç¤ºä¾‹
var buttonPermissions = []MenuPermissionConfig{
    // æ–°å¢æŒ‰é’®æƒé™
    {
        MenuID:         2, // user_create_btn
        PermissionCode: "user:create",
        IsRequired:     true,
    },
    // ç¼–è¾‘æŒ‰é’®æƒé™  
    {
        MenuID:         3, // user_edit_btn
        PermissionCode: "user:update", 
        IsRequired:     true,
    },
    // åˆ é™¤æŒ‰é’®æƒé™
    {
        MenuID:         4, // user_delete_btn
        PermissionCode: "user:delete",
        IsRequired:     true,
    },
}
```

### æŒ‰é’®æƒé™æ£€æŸ¥

```go
// è·å–ç”¨æˆ·å¯è§çš„æŒ‰é’®
func GetUserVisibleButtons(userID string, parentMenuID int64) []MenuButton {
    // è·å–çˆ¶èœå•ä¸‹çš„æ‰€æœ‰æŒ‰é’®
    buttons := getMenuButtons(parentMenuID)
    
    var visibleButtons []MenuButton
    for _, button := range buttons {
        // æ£€æŸ¥æŒ‰é’®æƒé™
        if hasMenuPermission(userID, button.ID) {
            visibleButtons = append(visibleButtons, button)
        }
    }
    
    return visibleButtons
}
```

### å‰ç«¯æŒ‰é’®æ¸²æŸ“

```javascript
// åŠ¨æ€æ¸²æŸ“æŒ‰é’®
const userButtons = getUserVisibleButtons(parentMenuId);

const renderButtons = () => {
    return userButtons.map(button => {
        switch(button.menu_code) {
            case 'user_create_btn':
                return <Button key="create" onClick={handleCreate}>æ–°å¢ç”¨æˆ·</Button>;
            case 'user_edit_btn':
                return <Button key="edit" onClick={handleEdit}>ç¼–è¾‘ç”¨æˆ·</Button>;
            case 'user_delete_btn':
                return <Button key="delete" onClick={handleDelete}>åˆ é™¤ç”¨æˆ·</Button>;
            default:
                return null;
        }
    });
};
```

---

## ğŸ“Š æ•°æ®æƒé™TODOæ–¹æ¡ˆ

### è®¾è®¡ç›®æ ‡

åœ¨ç°æœ‰æƒé™ç³»ç»ŸåŸºç¡€ä¸Šï¼Œå¢åŠ æ•°æ®çº§åˆ«çš„è®¿é—®æ§åˆ¶ï¼Œå®ç°ï¼š
- è¡Œçº§æ•°æ®æƒé™ï¼ˆRow-Level Securityï¼‰
- åˆ—çº§æ•°æ®æƒé™ï¼ˆColumn-Level Securityï¼‰
- æ¡ä»¶æ•°æ®æƒé™ï¼ˆConditional Accessï¼‰

### 1. æ•°æ®æƒé™å­˜å‚¨æ–¹æ¡ˆ

#### æ–¹æ¡ˆAï¼šæ‰©å±•ç°æœ‰æƒé™è¡¨ï¼ˆæ¨èï¼‰

```go
// æ‰©å±•æƒé™è¡¨ï¼Œæ”¯æŒæ•°æ®æƒé™
type DataPermission struct {
    PermissionCode string       `json:"permission_code"` // "user:data:own"
    Name          string        `json:"name"`            // "æŸ¥çœ‹è‡ªå·±çš„ç”¨æˆ·æ•°æ®"
    ResourceType  ResourceType  `json:"resource_type"`   // "data"
    ResourcePath  string        `json:"resource_path"`   // "users" (è¡¨å)
    Action        string        `json:"action"`          // "view"
    DataScope     DataScope     `json:"data_scope"`      // æ•°æ®èŒƒå›´
    FilterRule    string        `json:"filter_rule"`     // è¿‡æ»¤è§„åˆ™
}

// æ•°æ®æƒé™èŒƒå›´æšä¸¾
type DataScope string

const (
    DataScopeAll        DataScope = "all"        // å…¨éƒ¨æ•°æ®
    DataScopeOwn        DataScope = "own"        // ä»…è‡ªå·±çš„æ•°æ®
    DataScopeDept       DataScope = "dept"       // æœ¬éƒ¨é—¨æ•°æ®
    DataScopeDeptSub    DataScope = "dept_sub"   // æœ¬éƒ¨é—¨åŠä¸‹çº§éƒ¨é—¨
    DataScopeCustom     DataScope = "custom"     // è‡ªå®šä¹‰æ¡ä»¶
)
```

#### æ–¹æ¡ˆBï¼šç‹¬ç«‹æ•°æ®æƒé™è¡¨ï¼ˆå¯é€‰ï¼‰

```sql
-- æ•°æ®æƒé™è¡¨ï¼ˆå¦‚éœ€è¦æ›´å¤æ‚çš„æ•°æ®æƒé™ç®¡ç†ï¼‰
CREATE TABLE `data_permissions` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `tenant_id` bigint NOT NULL COMMENT 'ç§Ÿæˆ·ID',
  `permission_id` bigint NOT NULL COMMENT 'å…³è”æƒé™ID',
  `resource_table` varchar(100) NOT NULL COMMENT 'èµ„æºè¡¨å',
  `data_scope` enum('all','own','dept','dept_sub','custom') NOT NULL COMMENT 'æ•°æ®èŒƒå›´',
  `filter_rule` text COMMENT 'è¿‡æ»¤è§„åˆ™ï¼ˆJSONæ ¼å¼ï¼‰',
  `column_rules` text COMMENT 'åˆ—æƒé™è§„åˆ™ï¼ˆJSONæ ¼å¼ï¼‰',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_permission_id` (`permission_id`),
  KEY `idx_resource_table` (`resource_table`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='æ•°æ®æƒé™è¡¨';
```

### 2. æ•°æ®æƒé™é…ç½®ç¤ºä¾‹

```go
// æ•°æ®æƒé™é…ç½®ç¤ºä¾‹
var dataPermissions = []DataPermissionConfig{
    {
        PermissionCode: "user:data:all",
        Name:          "æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·æ•°æ®",
        ResourceTable: "users",
        DataScope:     DataScopeAll,
        FilterRule:    "",
    },
    {
        PermissionCode: "user:data:own",
        Name:          "æŸ¥çœ‹è‡ªå·±çš„ç”¨æˆ·æ•°æ®", 
        ResourceTable: "users",
        DataScope:     DataScopeOwn,
        FilterRule:    "user_id = :current_user_id",
    },
    {
        PermissionCode: "user:data:dept",
        Name:          "æŸ¥çœ‹æœ¬éƒ¨é—¨ç”¨æˆ·æ•°æ®",
        ResourceTable: "users", 
        DataScope:     DataScopeDept,
        FilterRule:    "department_id = :current_user_dept_id",
    },
    {
        PermissionCode: "order:data:region",
        Name:          "æŸ¥çœ‹åŒºåŸŸè®¢å•æ•°æ®",
        ResourceTable: "orders",
        DataScope:     DataScopeCustom,
        FilterRule:    "region_id IN (:user_region_ids)",
    },
}
```

### 3. æ•°æ®æƒé™æ£€æŸ¥é€»è¾‘

```go
// æ•°æ®æƒé™æ£€æŸ¥å™¨
type DataPermissionChecker struct {
    authz  *Authz
    db     *gorm.DB
}

// æ„å»ºæ•°æ®æŸ¥è¯¢æ¡ä»¶
func (checker *DataPermissionChecker) BuildDataFilter(userID string, tenantID int64, tableName string, action string) (string, map[string]interface{}, error) {
    // è·å–ç”¨æˆ·çš„æ•°æ®æƒé™
    dataPermissions := checker.getUserDataPermissions(userID, tenantID, tableName, action)
    
    if len(dataPermissions) == 0 {
        return "", nil, errors.New("no data permission")
    }
    
    // æ„å»ºè¿‡æ»¤æ¡ä»¶
    var conditions []string
    params := make(map[string]interface{})
    
    for _, perm := range dataPermissions {
        condition, permParams := checker.buildCondition(perm, userID, tenantID)
        if condition != "" {
            conditions = append(conditions, condition)
            for k, v := range permParams {
                params[k] = v
            }
        }
    }
    
    if len(conditions) == 0 {
        return "1 = 0", params, nil // æ— æƒé™ï¼Œè¿”å›ç©ºç»“æœ
    }
    
    // ä½¿ç”¨ORè¿æ¥å¤šä¸ªæƒé™æ¡ä»¶
    finalCondition := "(" + strings.Join(conditions, " OR ") + ")"
    return finalCondition, params, nil
}

// æ„å»ºå…·ä½“çš„è¿‡æ»¤æ¡ä»¶
func (checker *DataPermissionChecker) buildCondition(perm DataPermission, userID string, tenantID int64) (string, map[string]interface{}) {
    params := make(map[string]interface{})
    
    switch perm.DataScope {
    case DataScopeAll:
        return "1 = 1", params // æ— é™åˆ¶
        
    case DataScopeOwn:
        params["current_user_id"] = userID
        return "user_id = :current_user_id", params
        
    case DataScopeDept:
        userDeptID := checker.getUserDepartmentID(userID)
        params["current_user_dept_id"] = userDeptID
        return "department_id = :current_user_dept_id", params
        
    case DataScopeDeptSub:
        userDeptIDs := checker.getUserDepartmentAndSubIDs(userID)
        params["user_dept_ids"] = userDeptIDs
        return "department_id IN (:user_dept_ids)", params
        
    case DataScopeCustom:
        // è§£æè‡ªå®šä¹‰è§„åˆ™
        return checker.parseCustomRule(perm.FilterRule, userID, tenantID)
        
    default:
        return "1 = 0", params // é»˜è®¤æ— æƒé™
    }
}
```

### 4. æ•°æ®æƒé™åº”ç”¨

#### ORMé›†æˆ

```go
// GORMæ•°æ®æƒé™æ’ä»¶
type DataPermissionPlugin struct {
    checker *DataPermissionChecker
}

func (plugin *DataPermissionPlugin) Initialize(db *gorm.DB) error {
    // æ³¨å†ŒæŸ¥è¯¢å›è°ƒ
    db.Callback().Query().Before("gorm:query").Register("data_permission:query", plugin.beforeQuery)
    return nil
}

func (plugin *DataPermissionPlugin) beforeQuery(db *gorm.DB) {
    // ä»ä¸Šä¸‹æ–‡è·å–ç”¨æˆ·ä¿¡æ¯
    userID := getUserIDFromContext(db.Statement.Context)
    tenantID := getTenantIDFromContext(db.Statement.Context)
    
    if userID == "" {
        return // ç³»ç»Ÿè°ƒç”¨ï¼Œè·³è¿‡æƒé™æ£€æŸ¥
    }
    
    // è·å–è¡¨å
    tableName := db.Statement.Table
    if tableName == "" {
        return
    }
    
    // æ„å»ºæ•°æ®æƒé™è¿‡æ»¤æ¡ä»¶
    condition, params, err := plugin.checker.BuildDataFilter(userID, tenantID, tableName, "view")
    if err != nil {
        db.AddError(err)
        return
    }
    
    // æ·»åŠ åˆ°æŸ¥è¯¢æ¡ä»¶
    db.Where(condition, params)
}
```

#### ä¸šåŠ¡å±‚åº”ç”¨

```go
// ç”¨æˆ·æœåŠ¡ä¸­çš„æ•°æ®æƒé™åº”ç”¨
func (s *UserService) GetUsers(ctx context.Context, req *GetUsersRequest) (*GetUsersResponse, error) {
    // æ„å»ºåŸºç¡€æŸ¥è¯¢
    query := s.db.WithContext(ctx).Model(&User{})
    
    // åº”ç”¨ä¸šåŠ¡è¿‡æ»¤æ¡ä»¶
    if req.Status != "" {
        query = query.Where("status = ?", req.Status)
    }
    
    // æ•°æ®æƒé™ä¼šé€šè¿‡æ’ä»¶è‡ªåŠ¨åº”ç”¨
    // æ— éœ€æ‰‹åŠ¨æ·»åŠ æƒé™è¿‡æ»¤æ¡ä»¶
    
    var users []User
    err := query.Find(&users).Error
    if err != nil {
        return nil, err
    }
    
    return &GetUsersResponse{Users: users}, nil
}
```

### 5. åˆ—çº§æƒé™æ§åˆ¶

```go
// åˆ—æƒé™é…ç½®
type ColumnPermission struct {
    TableName    string   `json:"table_name"`
    ColumnName   string   `json:"column_name"`
    AllowedRoles []string `json:"allowed_roles"`
    MaskRule     string   `json:"mask_rule"` // è„±æ•è§„åˆ™
}

// åˆ—æƒé™æ£€æŸ¥
func (checker *DataPermissionChecker) FilterColumns(userID string, tableName string, data map[string]interface{}) map[string]interface{} {
    userRoles := checker.getUserRoles(userID)
    columnPerms := checker.getColumnPermissions(tableName)
    
    filteredData := make(map[string]interface{})
    
    for column, value := range data {
        perm := columnPerms[column]
        if perm == nil {
            // æ— é™åˆ¶åˆ—ï¼Œç›´æ¥è¿”å›
            filteredData[column] = value
            continue
        }
        
        // æ£€æŸ¥è§’è‰²æƒé™
        hasPermission := false
        for _, role := range userRoles {
            for _, allowedRole := range perm.AllowedRoles {
                if role == allowedRole {
                    hasPermission = true
                    break
                }
            }
            if hasPermission {
                break
            }
        }
        
        if hasPermission {
            filteredData[column] = value
        } else if perm.MaskRule != "" {
            // åº”ç”¨è„±æ•è§„åˆ™
            filteredData[column] = checker.applyMask(value, perm.MaskRule)
        }
        // æ— æƒé™ä¸”æ— è„±æ•è§„åˆ™ï¼Œåˆ™ä¸è¿”å›è¯¥å­—æ®µ
    }
    
    return filteredData
}

// è„±æ•å¤„ç†
func (checker *DataPermissionChecker) applyMask(value interface{}, maskRule string) interface{} {
    str := fmt.Sprintf("%v", value)
    
    switch maskRule {
    case "phone":
        // æ‰‹æœºå·è„±æ•ï¼š138****1234
        if len(str) == 11 {
            return str[:3] + "****" + str[7:]
        }
    case "email":
        // é‚®ç®±è„±æ•ï¼šabc***@example.com
        parts := strings.Split(str, "@")
        if len(parts) == 2 && len(parts[0]) > 3 {
            return parts[0][:3] + "***@" + parts[1]
        }
    case "id_card":
        // èº«ä»½è¯è„±æ•ï¼š110***********1234
        if len(str) >= 8 {
            return str[:3] + strings.Repeat("*", len(str)-7) + str[len(str)-4:]
        }
    }
    
    return "***" // é»˜è®¤è„±æ•
}
```

### 6. æ•°æ®æƒé™ç®¡ç†æ¥å£

```go
// æ•°æ®æƒé™ç®¡ç†API
type DataPermissionAPI struct {
    checker *DataPermissionChecker
}

// è·å–ç”¨æˆ·æ•°æ®æƒé™
func (api *DataPermissionAPI) GetUserDataPermissions(ctx context.Context, req *GetUserDataPermissionsRequest) (*GetUserDataPermissionsResponse, error) {
    permissions := api.checker.getUserDataPermissions(req.UserID, req.TenantID, req.TableName, req.Action)
    
    return &GetUserDataPermissionsResponse{
        Permissions: permissions,
    }, nil
}

// æµ‹è¯•æ•°æ®æƒé™
func (api *DataPermissionAPI) TestDataPermission(ctx context.Context, req *TestDataPermissionRequest) (*TestDataPermissionResponse, error) {
    condition, params, err := api.checker.BuildDataFilter(req.UserID, req.TenantID, req.TableName, req.Action)
    if err != nil {
        return nil, err
    }
    
    return &TestDataPermissionResponse{
        Condition: condition,
        Params:    params,
    }, nil
}
```

---

## ğŸ“‹ æƒé™è¡¨è®¾è®¡å¯¹æ¯”

| æƒé™ç±»å‹ | æ˜¯å¦éœ€è¦å…³è”è¡¨ | å­˜å‚¨æ–¹å¼ | å¤æ‚åº¦ | åº”ç”¨åœºæ™¯ |
|---------|---------------|----------|--------|----------|
| **èœå•æƒé™** | âœ… éœ€è¦ `menu_permissions` | å¤šå¯¹å¤šå…³è” | é«˜ | èœå•è®¿é—®æ§åˆ¶ã€æŒ‰é’®æ˜¾ç¤ºæ§åˆ¶ |
| **APIæƒé™** | âŒ ä¸éœ€è¦ | ç›´æ¥å­˜å‚¨åœ¨æƒé™è¡¨ | ä½ | APIæ¥å£è®¿é—®æ§åˆ¶ |
| **æŒ‰é’®æƒé™** | âœ… å¤ç”¨ `menu_permissions` | æŒ‰é’®ä½œä¸ºèœå•ç±»å‹ | ä¸­ | é¡µé¢æŒ‰é’®æ˜¾ç¤ºæ§åˆ¶ |
| **æ•°æ®æƒé™** | âŒ ä¸éœ€è¦ï¼ˆæ¨èï¼‰ | ç›´æ¥å­˜å‚¨åœ¨æƒé™è¡¨ | é«˜ | æ•°æ®è¡Œåˆ—çº§è®¿é—®æ§åˆ¶ |

### è®¾è®¡åŸåˆ™æ€»ç»“

1. **èœå•æƒé™éœ€è¦å…³è”è¡¨**çš„åŸå› ï¼š
   - å¤šå¯¹å¤šå¤æ‚å…³ç³»
   - æƒé™åˆ†çº§ï¼ˆå¿…éœ€/å¯é€‰ï¼‰
   - åŠ¨æ€é…ç½®éœ€æ±‚
   - UIæ§åˆ¶é€»è¾‘

2. **APIæƒé™ä¸éœ€è¦å…³è”è¡¨**çš„åŸå› ï¼š
   - ä¸€å¯¹ä¸€ç®€å•æ˜ å°„
   - é™æ€é…ç½®ä¸ºä¸»
   - ç›´æ¥å­—æ®µå­˜å‚¨è¶³å¤Ÿ

3. **æ•°æ®æƒé™ä¸éœ€è¦å…³è”è¡¨**çš„åŸå› ï¼š
   - é€šè¿‡æƒé™ç¼–ç å’Œè§„åˆ™é…ç½®
   - é¿å…è¿‡åº¦è®¾è®¡
   - ç»Ÿä¸€æƒé™ç®¡ç†

---

## ğŸš€ å®æ–½å»ºè®®

### é˜¶æ®µä¸€ï¼šå®Œå–„ç°æœ‰æƒé™ç³»ç»Ÿ

1. **ä¿®å¤èœå•ç±»å‹å®šä¹‰**
   ```go
   // å°† MenuType ä» bool æ”¹ä¸º int8
   MenuType MenuType `gorm:"column:menu_type;not null;default:1" json:"menu_type"`
   ```

2. **å®Œå–„èœå•æƒé™åŠŸèƒ½**
   - å®ç°åŠ¨æ€èœå•æƒé™é…ç½®
   - å®Œå–„æƒé™æ£€æŸ¥ä¸­é—´ä»¶
   - ä¼˜åŒ–å‰ç«¯æƒé™æ§åˆ¶

3. **å¢å¼ºAPIæƒé™**
   - å®Œå–„APIæƒé™è‡ªåŠ¨å‘ç°
   - å®ç°APIæƒé™æ‰¹é‡é…ç½®
   - ä¼˜åŒ–æƒé™æ£€æŸ¥æ€§èƒ½

### é˜¶æ®µäºŒï¼šå®æ–½æ•°æ®æƒé™

1. **æ‰©å±•æƒé™è¡¨ç»“æ„**
   ```sql
   ALTER TABLE permissions 
   ADD COLUMN `data_scope` enum('all','own','dept','dept_sub','custom') DEFAULT NULL COMMENT 'æ•°æ®æƒé™èŒƒå›´',
   ADD COLUMN `filter_rule` text COMMENT 'æ•°æ®è¿‡æ»¤è§„åˆ™';
   ```

2. **å®ç°æ•°æ®æƒé™æ£€æŸ¥å™¨**
   - å¼€å‘ `DataPermissionChecker`
   - å®ç° GORM æ’ä»¶
   - é›†æˆåˆ°ä¸šåŠ¡æœåŠ¡

3. **å¼€å‘ç®¡ç†ç•Œé¢**
   - æ•°æ®æƒé™é…ç½®ç•Œé¢
   - æƒé™æµ‹è¯•å·¥å…·
   - æƒé™å®¡è®¡åŠŸèƒ½

### é˜¶æ®µä¸‰ï¼šä¼˜åŒ–å’Œæ‰©å±•

1. **æ€§èƒ½ä¼˜åŒ–**
   - æƒé™ç¼“å­˜æœºåˆ¶
   - æŸ¥è¯¢æ¡ä»¶ä¼˜åŒ–
   - æ‰¹é‡æƒé™æ£€æŸ¥

2. **åŠŸèƒ½æ‰©å±•**
   - åˆ—çº§æƒé™æ§åˆ¶
   - æ•°æ®è„±æ•åŠŸèƒ½
   - æƒé™ç»§æ‰¿æœºåˆ¶

3. **ç›‘æ§å’Œå®¡è®¡**
   - æƒé™ä½¿ç”¨ç»Ÿè®¡
   - æƒé™å˜æ›´å®¡è®¡
   - å®‰å…¨å‘Šè­¦æœºåˆ¶

### æŠ€æœ¯è¦ç‚¹

1. **æƒé™ç¼“å­˜ç­–ç•¥**
   ```go
   // Redisç¼“å­˜ç”¨æˆ·æƒé™
   key := fmt.Sprintf("user_permissions:%s:%d", userID, tenantID)
   permissions := redis.Get(key)
   ```

2. **æƒé™æ£€æŸ¥ä¼˜åŒ–**
   ```go
   // æ‰¹é‡æƒé™æ£€æŸ¥
   func BatchCheckPermissions(userID string, permissions []string) map[string]bool
   ```

3. **æƒé™ç»§æ‰¿æœºåˆ¶**
   ```go
   // è§’è‰²æƒé™ç»§æ‰¿
   func GetInheritedPermissions(userID string) []Permission
   ```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Casbinæƒé™ç®¡ç†æ¡†æ¶](https://casbin.org/)
- [RBACæƒé™æ¨¡å‹è®¾è®¡](https://en.wikipedia.org/wiki/Role-based_access_control)
- [æ•°æ®æƒé™è®¾è®¡æ¨¡å¼](https://martinfowler.com/articles/web-security-basics.html)
- [GORMæ’ä»¶å¼€å‘æŒ‡å—](https://gorm.io/docs/write_plugins.html)

---

*æœ¬æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.0*  
*æœ€åæ›´æ–°ï¼š2024å¹´12æœˆ*  
*ç»´æŠ¤è€…ï¼šå¼€å‘å›¢é˜Ÿ* 